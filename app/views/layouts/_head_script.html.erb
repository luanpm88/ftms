<script>
	
	function changeMailingPreferred(input) {		
		if (input.val() == "company" && $('input[name="contact[referrer_id]"]').val() == "") {
			alert("Must choose company first!")
			input.select2("val", 'home');
		}
		
		if (input.val() == "company" || input.val() == "home") {
			$('.mailing_address_box').hide()
			$('.mailing_address_box').val("")
		} else {
			$('.mailing_address_box').show()
		}
	}
	
	function changeComanyTrigger(input) {
		if (input.val() == "") {
			$('select[name="contact[payment_type]"]').select2("val","self-financed")
			if ($('select[name="contact[preferred_mailing]"]').val() == "company") {
				$('select[name="contact[preferred_mailing]"]').select2("val", 'home');
			}
		}
	}
	
	function updateSeminarContactsCount() {
		var total = $('.datatable-seminar-students').dataTable().fnSettings().fnRecordsTotal()				
		$('.seminar_students_count').html(total)
	}
	
	function removeContactToSeminar(seminar_id, contact_ids) {		
		$.ajax({
			url : '<%= remove_contacts_seminars_path %>?id='+seminar_id+'&contact_ids='+contact_ids.join(","),
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{
				$('.datatable-seminar-students').dataTable().fnFilter();
				clearListCheck()
				
			}
		});
	}
	
	function addContactToSeminar(seminar_id, contact_ids) {		
		$.ajax({
			url : '<%= add_contacts_seminars_path %>?id='+seminar_id+'&contact_ids='+contact_ids.join(","),
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{
				$('.datatable-seminar-students').dataTable().fnFilter();
				clearListCheck()
				$('input[name="contacts"]').select2("val","")
			}
		});
	}
	
	var related_info_input
	function checkRelatedInfo(input) {
		var url = input.attr("rel")
		var value = input.val()
		var box = input.parent().find(".related_info_box")
		var msg = input.parent().find(".related_info_msg")
			
		if(typeof(related_info_input) != "undefined") {
			related_info_input.abort()
		}			
		related_info_input = $.ajax({
			url : url,
			type: "GET",
			data: "value="+value,
			success:function(data, textStatus, jqXHR)
			{
				if(data.trim() != "") {
					box.html(data)
					box.show()
					msg.show()
					input.addClass("has_related_info")
				} else {
					box.hide()
					msg.hide()
					input.removeClass("has_related_info")
				}
			}
		});
	}
	
	function clearListCheck() {
		$('.listing_form table input[type="checkbox"]').attr("checked",false);
		$('.check_all_page').attr("checked",false);
		
		$('.listing_form table tr').removeClass("row_selected")
		
		$('.listing_box_actions .listing_checked_count').html("0")
	}
	
	function allListCheck() {		
		$('.check_all_page').attr("checked",true);
		$('.listing_form table input[type="checkbox"]').attr("checked",true);
		$('.listing_form table tr').addClass("row_selected")
		
		var total = $('.dataTable ').dataTable().fnSettings().fnRecordsTotal()
		
		$('.listing_box_actions .listing_checked_count').html(total)
	}
	
	function updateSubjectsFilterBox() {
		var box = $('.subjects-filter-box')
		var program_val = ""
		if ($('select[name="filter[course_types[]]"]').val() != null) {
			program_val = $('select[name="filter[course_types[]]"]').val().join(",")
		}
		$.ajax({
			url : '<%= ajax_quick_info_contacts_path %>?id='+cid,
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{
				box.html(data);
			}
		});
	}
	
	function ajaxQuickContactInfo(cid,box) {		
		if (typeof(cid) == "undefined" || typeof(box) == "undefined") {
			return
		}
		
		if (cid == "") {
			box.html("")
			return
		}
		$.ajax({
			url : '<%= ajax_quick_info_contacts_path %>?id='+cid,
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{
				box.html(data);
			}
		});
	}
	
	function updateContactTag(c_id, t_id) {
		$.ajax({
			url : '<%= update_tag_contacts_path %>?id='+c_id+'&tag_id='+t_id,
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{
				
				$('.contact_tag_box[rel="'+c_id+'"]').html(data);
			}
		});
	}
	
	function checkContactType() {
		if($('input[name="contact[is_individual]"]:checked').val() == "true" || $('select[name="is_individual"]').val() == "true") {
			$(".personal-box").show();
			$(".company-box").hide();
		} else {
			$(".personal-box").hide();
			$(".company-box").show();
		}
	}
	
	function checkInvoiceRequired() {
		if($('input[name="contact[invoice_required]"]:checked').val() == "true") {
			$(".invoice-info-box").show();
		} else {
			$(".invoice-info-box").hide();
		}
	}
	
	function reloadTab(tid, force) {
		if (typeof(force) == "undefined") {
			force = false
		}
		
		//if ($(".main-frame").length && !force) {
		//	$(".main-frame")[0].contentWindow.reloadDatatable()
		//} else {
			$('iframe#'+tid).attr("src",$('iframe#'+tid).attr("src"))
		//}		
	}
	function closeTab(tid) {
		//open parent		
		var pname = $("#main-tab li.active a").attr("pname")
		var psrc = $("#main-tab li.active a").attr("psrc")
		
		if (typeof(pname) != 'undefined') {
		  openTab(psrc,pname)
		}
		
		//close current
		var active = $('#main-tab a[rel="'+tid+'"]').parent().hasClass("active")		
        $('#main-tab a[rel="'+tid+'"]').parent().remove()
		$('.tab-content div#'+tid).remove()
		
		if(active) {
          $('#main-tab li:last-child a').tab('show')
        }
        
        $(document).scrollTop(0);
		
		clearInterval(tabs[tid])
	}
	var tabs = Array()
	function openTab(tsrc, tname, psrc, pname) {
		if (typeof(tname) == 'undefined' || tname == 'undefined') {
			tname = $('a[href="'+tsrc+'"]').html().trim();
		}
		
		var tid = "tab_"+tname.replace(/\s/g, "_").replace(/[^a-zA-Z0-9\_]/g, "").toLowerCase();
		
		if($('a[tsrc="'+tsrc+'"]').length == 0) {
			
			var parent = ""
			if (psrc) {
				parent = ' psrc="'+psrc+'" pname="'+pname+'" '
			}
			
		  $('#main-tab').append('<li class=""><a tsrc="'+tsrc+'" tname="'+tname+'" '+parent+' rel="'+tid+'" href="#'+tid+'">'+tname+'<i class="but but-reload icon-refresh"></i><i class="but but-del icon-remove-sign"></i></a></li>')
		  $('.tab-content').append('<div id="'+tid+'" class="tab-pane"><iframe class="main-frame" id="'+tid+'" seamless="seamless" scrolling="yes" src="'+tsrc+'"></iframe></div>')
			$('#main-tab a').click(function (e) {
				  e.preventDefault();
				  $(this).tab('show');
			});
		  $('#main-tab a[rel="'+tid+'"]').tab('show')
			tabs[tid] = resizeIframe(tid)
		  
			$('#main-tab a[rel="'+tid+'"]').parent().find(".but-del").click(function (e) {
                closeTab(tid)
			});
			$('#main-tab a[rel="'+tid+'"]').parent().find(".but-reload").click(function (e) {
                reloadTab(tid, true)
			});
			
			

			$('iframe#'+tid).load(function(){
				$(document).scrollTop(0);
			});


		} else {
		  $('#main-tab a[rel="'+tid+'"]').tab('show')
		  
		  reloadTab(tid)
		}
		$(document).scrollTop(0);
		if($(window).width() <= 750 && $('.page-sidebar').css("display") == "block") {
			$('#main-menu-toggle').trigger("click");
		}
	}
	
	function resizeIframe(tid) {
		
		var obj = $('iframe#'+tid)
		var lastHeight = 0, curHeight = 0, $frame = obj;
		iid = setInterval(function(){
		  curHeight = $frame.contents().find('body').height();
		  if ( curHeight != lastHeight ) {
			$frame.css('height', ((lastHeight = curHeight)+85) + 'px' );
		  }
		},500);
		
		return iid
    }
	
	function readURL(input, image) {
		if (input.files && input.files[0]) {
			var reader = new FileReader();	
			reader.onload = function (e) {
				image.attr('src', e.target.result);
			}	
			reader.readAsDataURL(input.files[0]);
		}
	}
	
	function updateBoxesOrder() {
		var ord = 1
		$('.image-boxes .image-box').each(function() {
			$(this).find(".display_order").val(ord)
			ord++
		})
	}
	
	function uploaderBoxes() {
		$('.image-boxes .image-box a').click(function(e) {
			e.preventDefault();
			$(this).parent().find("input[type='file']").trigger("click")
		})		
		$('.image-boxes .image-box input[type="file"]').change(function() {
			img = $(this).parents('.image-box').find("img.new_picture")
			icon = $(this).parents('.image-box').find(".current_img")
			del_icon = $(this).parents('.image-box').find(".delete-but")
			readURL(this, img);
			img.removeClass("hidden");
			icon.addClass("hidden");
			del_icon.removeClass("hidden");
			
			$(this).parents('.image-box').find(".destroy_tag").val("")
		});
		$('.image-boxes .image-box .delete-but').click(function(e) {
			img = $(this).parents('.image-box').find("img.new_picture")
			icon = $(this).parents('.image-box').find(".current_img")
			$(this).parent().find("input[type='file']").val("")
			img.addClass("hidden");
			icon.removeClass("hidden");
			
			$(this).parents('.image-box').find(".current_image_pic").addClass("hidden");
			$(this).parents('.image-box').find(".current_image_icon").removeClass("hidden");
			
			$(this).addClass("hidden");
			
			$(this).parents('.image-box').find(".destroy_tag").val(1)
		})
	}
	
	function format_price(element) {
		element.inputmask("decimal", { radixPoint: ".", autoGroup: true, groupSeparator: ",", digits: 2, groupSize: 3 });
	}
	
	function show_city_select_tag() {
		state = ""
		if($('#state_id').length > 0) {
			state = "?state_id="+$('#state_id').val()
		}
		$.ajax({
			url : '<%= select_tag_cities_url %>'+state,
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{		    
				$(".city_select_box").html(data);
				$(".city_select_tag").select2();
			}
		});
	}
	
	function read_notification() {
		$.ajax({
			url : '<%= read_notification_notifications_url %>',
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{		    
				//update_notification();
			}
		});
	}
	
	function update_notification() {
		$.ajax({
			url : '<%= update_notification_notifications_url %>',
			type: "GET",
			success:function(data, textStatus, jqXHR)
			{		    
				$('.top_notification').html(data);				
				$('.notification_count').html($('<div>').html(data).find('.notification_count').html().trim());
			}
		});
	}	
    
    function ReplaceNumberWithDots(yourNumber) {
		yourNumber = yourNumber.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		return yourNumber
    }
    
      
      
    $(document).ready(function() {
  
		////TABLES
		//Too Small for new file - Helps the to tick all options in the table 
		$('table .checkbox input').click( function() {			
			if($(this).is(':checked')){			
				$(this).parent().parent().parent().toggleClass('row_selected');					
			}
			else{	
			$(this).parent().parent().parent().toggleClass('row_selected');		
			}
		});
		// Demo charts - not required 
		$('.customer-sparkline').each(function () {	
			$(this).sparkline('html', { type:$(this).attr("data-sparkline-type"), barColor:$(this).attr("data-sparkline-color") , enableTagOptions: true });	
		});
	
		//Multiselect for all
		$(".multi_select").select2();
		$(".modern_select").select2({
			allowClear: true,
			placeholder: "All"
		});
		$(".datetime select").select2();
	
		//filter table
		$('table').not('.no-filter').filterTable();
	
		//prevent submit while submitting form
		$('.btn-submitting').live("click", function(e){ e.preventDefault(); });
	
	    //format typping price
	    //$('input.price_input').number( true, 2 );
		format_price($('input.price_input'));
	    
	    //show order
	    //action for add agent button
	    $('.ajax_iframe').fancybox({
		    width: "100%",
		    height: "100%",
		    autoSize: false,
		    ajax: {
			complete: function(jqXHR, textStatus) {
			    //$(".ajax_outer .modern_select").select2();
			}
		    }
	    });
	    
	    //NICE FILE INPUT
	    $("input[type=file]").nicefileinput();
	    
	    //Datatable products
	    $('.datatable-users').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_users_path %>",
				"data": function ( d ) {
					
				}
			},
			"columnDefs": [ { "targets": [0,2,4], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable contacts
	    $('.datatable-contacts').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_contacts_path %>",
				"data": function ( d ) {
					var types = $(".contact_types input:checkbox:checked").map(function(){
						return $(this).val();
					}).get();
					
					if($("select[name=is_individual]").select2("val") == "true") {						
						d.contact_types = types;
					}
					
					d.is_individual = $("select[name=is_individual]").select2("val");
					
					if($("select[name='tags[]'").val()) {
						d.tags = $("select[name='tags[]'").val()
					}
					
					if($("select[name='course_types[]']").val()) {
						d.course_types = $("select[name='course_types[]']").val()
					}
					
					if($("select[name='subjects[]']").val()) {
						d.subjects = $("select[name='subjects[]']").val()
					}
					
					if($("select[name='filter[intake(2i)]']").val()) {
						d.intake_month =  $("select[name='filter[intake(2i)]']").val()
					}
					
					if($("select[name='filter[intake(1i)]']").val()) {
						d.intake_year =  $("select[name='filter[intake(1i)]']").val()
					}
					
					if($("input[name='courses']").val()) {
						d.courses =  $("input[name='courses']").val()
					}
					
					if($("input[name='seminars']").val()) {
						d.seminars =  $("input[name='seminars']").val()
					}
				}
			},
			"columnDefs": [ { "targets": [0,1,3,4,5,6,7,8,9], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable contacts
	    $('.datatable-seminar-students').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= seminar_students_contacts_path %>",
				"data": function ( d ) {
					var types = $(".contact_types input:checkbox:checked").map(function(){
						return $(this).val();
					}).get();
					
					if($("select[name=is_individual]").select2("val") == "true") {						
						d.contact_types = types;
					}
					
					d.is_individual = $("select[name=is_individual]").select2("val");
					
					if($("select[name='tags[]'").val()) {
						d.tags = $("select[name='tags[]'").val()
					}
					
					if($("select[name='course_types[]']").val()) {
						d.course_types = $("select[name='course_types[]']").val()
					}
					
					if($("select[name='subjects[]']").val()) {
						d.subjects = $("select[name='subjects[]']").val()
					}
					
					if($("select[name='filter[intake(2i)]']").val()) {
						d.intake_month =  $("select[name='filter[intake(2i)]']").val()
					}
					
					if($("select[name='filter[intake(1i)]']").val()) {
						d.intake_year =  $("select[name='filter[intake(1i)]']").val()
					}
					
					if($("input[name='courses']").val()) {
						d.courses =  $("input[name='courses']").val()
					}
					
					if($("input[name='seminars']").val()) {
						d.seminars =  $("input[name='seminars']").val()
					}
				}				
			},
			"columnDefs": [ { "targets": [0,1,3,4,5,6,7,8], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25,
			"fnDrawCallback": function () {
				updateSeminarContactsCount()
			}
	    });
		
		//Datatable contacts
	    $('.datatable-course-students').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= course_students_contacts_path %>",
				"data": function ( d ) {
					var types = $(".contact_types input:checkbox:checked").map(function(){
						return $(this).val();
					}).get();
					
					if($("select[name=is_individual]").select2("val") == "true") {						
						d.contact_types = types;
					}
					
					d.is_individual = $("select[name=is_individual]").select2("val");
					
					if($("select[name='tags[]'").val()) {
						d.tags = $("select[name='tags[]'").val()
					}
					
					if($("select[name='course_types[]']").val()) {
						d.course_types = $("select[name='course_types[]']").val()
					}
					
					if($("select[name='subjects[]']").val()) {
						d.subjects = $("select[name='subjects[]']").val()
					}
					
					if($("select[name='filter[intake(2i)]']").val()) {
						d.intake_month =  $("select[name='filter[intake(2i)]']").val()
					}
					
					if($("select[name='filter[intake(1i)]']").val()) {
						d.intake_year =  $("select[name='filter[intake(1i)]']").val()
					}
					
					if($("input[name='courses']").val()) {
						d.courses =  $("input[name='courses']").val()
					}
					
					if($("input[name='seminars']").val()) {
						d.seminars =  $("input[name='seminars']").val()
					}
				}
			},
			"columnDefs": [ { "targets": [0,1,3,4,5,6,7,8], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		
		//Datatable course types
	    $('.datatable-course-types').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_course_types_path %>",
				"data": function ( d ) {
					
				}
			},
			"columnDefs": [ { "targets": [3,4], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable subjects
	    $('.datatable-subjects').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_subjects_path %>",
				"data": function ( d ) {
					d.course_types = $("select[name='filter[course_types[]]']").val()
				}
			},
			"columnDefs": [ { "targets": [1,3,4], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable courses
	    $('.datatable-courses').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_courses_path %>",
				"data": function ( d ) {
					d.intake_month =  $("select[name='filter[intake(2i)]']").val(),
					d.intake_year =  $("select[name='filter[intake(1i)]']").val(),
					d.course_types = $("select[name='filter[course_types[]]']").val()
					d.subjects = $("select[name='filter[subjects[]]']").val()
					d.students = $("input[name='filter[students[]]']").val()
					d.lecturers = $("input[name='filter[lecturers[]]']").val()
				}
			},
			"columnDefs": [ { "targets": [2,3,4,6,7], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable courses
	    $('.datatable-student-courses').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= student_courses_courses_path %>",
				"data": function ( d ) {
					d.intake_month =  $("select[name='filter[intake(2i)]']").val(),
					d.intake_year =  $("select[name='filter[intake(1i)]']").val(),
					d.course_types = $("select[name='filter[course_types[]]']").val()
					d.subjects = $("select[name='filter[subjects[]]']").val()
					d.students = $("input[name='filter[students[]]']").val()
					d.lecturers = $("input[name='filter[lecturers[]]']").val()
				}
			},
			"columnDefs": [ { "targets": [2,3,4], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable books
	    $('.datatable-books').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_books_path %>",
				"data": function ( d ) {
					
				}
			},
			"columnDefs": [ { "targets": [0,2,5,6], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable courses
	    $('.datatable-contact-tags').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_contact_tags_path %>",
				"data": function ( d ) {
					
				}
			},
			"columnDefs": [ { "targets": [1,2,3], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
	    
		//Datatable seminars
	    $('.datatable-seminars').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_seminars_path %>",
				"data": function ( d ) {
					d.course_types = $("select[name='filter[course_types[]]']").val()
				}
			},
			"columnDefs": [ { "targets": [1,2,3,5], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
		//Datatable subjects
	    $('.datatable-phrases').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_phrases_path %>",
				"data": function ( d ) {
					d.subjects = $("select[name='filter[subjects[]]']").val()
					d.course_types = $("select[name='filter[course_types[]]']").val()
				}
			},
			"columnDefs": [ { "targets": [1,2,4,5], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
		
	    $('select[name="DataTables_Table_0_length"]').select2({allowClear: true});
		
		//ajax select2 for contacts
	    $('.select2-ajax-contacts').select2({
			placeholder: "Search for a contact",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-contacts').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-contacts').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term				  
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contacts
	    $('.select2-ajax-lecturers').select2({
			placeholder: "Search for a contact",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-lecturers').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-lecturers').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term				  
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contacts
	    $('.select2-ajax-students').select2({
			placeholder: "Search for a contact",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-students').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-students').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term				  
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for state
	    $('.select2-ajax-states').select2({
			placeholder: "Search for a state",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-states').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-states').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contacts
	    $('.select2-ajax-course-types').select2({
			placeholder: "Search for a course type",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-course-types').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-course-types').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  if (!element.hasClass("multiple")) {
				callback({ id: element.val(), text: element.attr('text') });
			  } else {
				
			  }
			}
	    });
		
		//ajax select2 for contacts		
	    $('.select2-ajax-subjects').select2({
			placeholder: "Search for a subject",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-subjects').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-subjects').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contacts
	    $('.select2-ajax-course-types-subjects').select2({
			placeholder: "Search for a Program - Paper",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-course-types-subjects').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-course-types-subjects').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contact tags
	    $('.select2-ajax-contact-tags').select2({
			placeholder: "Search for a tag",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-contact-tags').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-contact-tags').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contacts
	    $('.select2-ajax-courses').select2({
			placeholder: "Search for a course",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-courses').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-courses').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term				  
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contacts
	    $('.select2-ajax-books').select2({
			placeholder: "Search for a book",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-books').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-books').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term				  
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//ajax select2 for contacts		
	    $('.select2-ajax-phrases').select2({
			placeholder: "Search for a phrase",
			minimumInputLength: 1,
			allowClear: true,
			multiple: $('.select2-ajax-phrases').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-phrases').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val(), text: element.attr('text') });
			}
	    });
		
		//Datatable subjects
	    $('.datatable-discount-programs').dataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "<%= datatable_discount_programs_path %>",
				"data": function ( d ) {
					d.course_types = $("select[name='filter[course_types[]]']").val()
				}
			},
			"columnDefs": [ { "targets": [1,5,6], "orderable": false } ],
			"order": [],
			"aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
			"iDisplayLength": 25
	    });
	    
	    $('.dataTables_length select').select2({allowClear: true});
	    
	    $('.date_select_filter select').eq(0).select2({
			allowClear: true,
			placeholder: "year"
	    });
	    
	    $('.date_select_filter select').eq(1).select2({
			allowClear: true,
			placeholder: "month"
	    });
	    
	    $('.date_select_filter select').eq(2).select2({
			allowClear: true,
			placeholder: "day"
	    });
	    
	    $('.select2-ajax-users').select2({
			placeholder: "Search for a user",
			allowClear: true,
			minimumInputLength: 1,
			ajax: {
			  url: $('.select2-ajax-users').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
			  callback({ id: element.val, text: element.attr('text') });
			}
	    });
		
		$('.select2-ajax-seminars').select2({
			placeholder: "Search for a seminar",
			allowClear: true,
			minimumInputLength: 1,
			//multiple: $('.select2-ajax-seminars').hasClass("multiple"),
			ajax: {
			  url: $('.select2-ajax-seminars').attr("data"),
			  dataType: 'json',
			  data: function (term, page) { // page is the one-based page number tracked by Select2
				return {
				  q: term, //search term
				};
			  },
			  results: function (data, page) {
				return {results: data};
			  }
			},
			initSelection: function (element, callback) {				      
				callback({ id: element.val, text: element.attr('text') });
			}
	    });
	    
		//number input
	    $('input.number_input').number(true, 2);
		
		//select2 for datatable
		setTimeout("$('.dataTables_wrapper select').select2();", 2000);
		
		//fancybox link
		$('.fancybox_link').fancybox({width: "100%",'autoDimensions': false, 'autoSize':false});
		
		//contact filter
		$("#contact_filter input, #contact_filter select").click(function() {
			$('.datatable-contacts').dataTable().fnFilter();
			$('.datatable-course-students').dataTable().fnFilter();
			$('.datatable-seminar-students').dataTable().fnFilter();
			
			clearListCheck()
	    });		
		
		$('#tab-01 a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});
		
		$('#avatar_capture a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});
		
		updateBoxesOrder()
		$( "#sortable" ).sortable({
			helper : 'clone',
			update: function( event, ui ) {
				updateBoxesOrder()
			}
		});
		$( "#sortable" ).disableSelection();

		
		//upload image boxes
		uploaderBoxes()
		
		//form validation
		$('form').validate();
		
		$('#main-tab a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});
		
		$(document).on("click",".tab_page", function(e) {
			e.preventDefault()
			
			pname = false
			psrc = false
			if (typeof($(this).attr("psrc")) != 'undefined') {
				pname = $(this).attr("pname")
				psrc = $(this).attr("psrc")
			}
			
			if($('body.main-frame-page').length) {
              openTab($(this).attr("href"), $(this).attr("title"),psrc,pname)
            } else {
              parent.openTab($(this).attr("href"), $(this).attr("title"),psrc,pname)
            }
		})
        
        $(document).on("click",".main-content-frame .cancel-but",function(e) {
			e.preventDefault()			
			parent.closeTab(window.parent.$("#main-tab li.active a").attr("href").replace("#",""))
		})
		
		$('.date-group select').select2();
		
		$('.course-filter select, .course-filter input').change(function() {
			$('.datatable-courses').dataTable().fnFilter();
			$('.datatable-student-courses').dataTable().fnFilter();
			$('.datatable-subjects').dataTable().fnFilter();
			$('.datatable-seminars').dataTable().fnFilter();
			$('.datatable-phrases').dataTable().fnFilter();
		});
		
		checkContactType()
		$('input[name="contact[is_individual]"], select[name="is_individual"]').change(function() {
			checkContactType()
		});
		
		checkInvoiceRequired()
		$('input[name="contact[invoice_required]"]').change(function() {
			checkInvoiceRequired()
		});
		
		$(document).on("click",".contact_tag_item",function() {
			updateContactTag($(this).attr("rel"), $(this).attr("tag_id"))
		})
		
		ajaxQuickContactInfo($('input[name="contact[referrer_id]"]').val(),$('.selected_company_info'))
		$('input[name="contact[referrer_id]"]').change(function() {
			ajaxQuickContactInfo($(this).val(),$('.selected_company_info'))
			changeComanyTrigger($(this))
		})
		
		ajaxQuickContactInfo($('input[name="contact[invoice_info_id]"]').val(),$('.selected_invoice_info'))
		$('input[name="contact[invoice_info_id]"]').change(function() {
			ajaxQuickContactInfo($(this).val(),$('.selected_invoice_info'))
		})
		
		$(document).on("click",".refresh_contact_info",function() {
			ajaxQuickContactInfo($(this).attr("rel"),$(this).parent().parent())
		})
		
		$('select[name="contact[payment_type]"]').change(function() {
			if ($(this).val() == "company-sponsored" && $('input[name="contact[referrer_id]"]').val() == "") {
				alert("Must choose company first!")
				$(this).select2("val", 'self-financed');
			}
		})
		
		$(document).on("change","table .checkbox input",function() {
			if($(this).is(":checked")) {
				$(this).parents("tr").addClass("row_selected")
			} else {
				$(this).parents("tr").removeClass("row_selected")
			}
			var count = $('input[name="ids[]"]:checked').length
			$('.listing_box_actions .listing_checked_count').html(count)
			
			$('.check_all_page').attr("checked",false)
		})
		
		$(document).on("click",".listing_actions li a",function() {
			if ($(this).attr("rel").trim() == "") {
				return
			}
			var count = $('input[name="ids[]"]:checked').length
			if (count > 0) {
				$(".listing_form").attr("action", $(this).attr("rel"))
				$(".listing_form").submit()
			} else {
				alert("Need to choose contact(s) first!")
			}
			
		})
		
		$(document).on("change",".check_all_page",function() {
			if($(this).is(":checked")) {
				allListCheck()
			} else {
				clearListCheck()
			}
		})
		
		
		$(document).on("keyup",".related_info_input",function() {			
			checkRelatedInfo($(this))
		})
		$('.related_info_input').focus( function() {
			checkRelatedInfo($(this))
		});		  
		$(document).click( function() {
			$(".related_info_box").hide()
		});
		$('.related_info_input').click( function() {
			checkRelatedInfo($(this))
		});
		$('.related_info_input').change( function() {
			checkRelatedInfo($(this))
		});
		
		$('.datetimepicker').datetimepicker();
		
		
		
		$(document).on("click",".add_contact_to_seminar_but",function() {			
			var contact_ids = $('input[name="contacts"]').select2("val")
			
			if (contact_ids.length > 0) {
				addContactToSeminar($(this).attr("rel"), contact_ids)
			} else {
				alert("Contact box is empty! Let's find contact(s) first.")
			}
		})
		
		$(document).on("click",".remove_contact_from_seminar_but",function() {			
			var contact_ids = [$(this).attr("contact_ids")]
			
			if (contact_ids.length > 0) {
				removeContactToSeminar($(this).attr("rel"), contact_ids)
			}
		})
		
		$(document).on("click",".remove_contacts_from_seminar_but",function() {			
			var contact_ids = $('table input[name="ids[]"]:checked').map(function(){
						return $(this).val();
					}).get();
			var count = $('table input[name="ids[]"]:checked').length
			if (count > 0) {
				if (contact_ids.length > 0) {
					removeContactToSeminar($(this).attr("sid"), contact_ids)
				}
			} else {
				alert("Need to choose contact(s) first!")
			}
		})
		
		$('.fancybox').fancybox();
		
		changeMailingPreferred($('select[name="contact[preferred_mailing]"]'))
		$('select[name="contact[preferred_mailing]"]').change(function() {
			changeMailingPreferred($(this))
		})
		
		
		$('.phrase_box .main_input').change(function() {
			var value = $(this).val()
			var next_box = $(this).parents(".phrase_box").next()
			if (value != "") {
				next_box.show()
			} else if (next_box.find(".main_input").val() == "") {
				next_box.hide()
			}
		})
		
		$('.registration_course').change(function() {
			var url = $(this).attr("box_url")
			var course_id = $(this).val()
			var number = $(this).attr("box_number")
			var full_url = url+'?id='+course_id+'&number='+number
			var box = $('.'+$(this).attr("box_id"))
			
			$.ajax({
				url : full_url,
				type: "GET",
				success:function(data, textStatus, jqXHR)
				{
					box.html(data)
				}
			});
		})
		
		$(document).on("click", ".ajax-check-radio", function(e) {
			e.preventDefault();
			
			var box = $(this).parent()
			var url = $(this).attr("href")
			
			$.ajax({
				url : url,
				type: "GET",
				success:function(data, textStatus, jqXHR)
				{
					box.html(data)
				}
			});
		});
});

</script>