<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:x="urn:schemas-microsoft-com:office:excel"
  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:html="http://www.w3.org/TR/REC-html40">
  <Styles>
    <Style ss:ID="Default" ss:Name="Normal">
     <Alignment ss:Vertical="Bottom"/>
     <Borders/>
     <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>
     <Interior/>
     <NumberFormat/>
     <Protection/>
    </Style>
    <Style ss:ID="s62">
     <Alignment ss:Vertical="Bottom" ss:WrapText="1"/>
    </Style>
    <Style ss:ID="s63">
     <Alignment ss:Vertical="Top"/>
    </Style>
   </Styles>
  <Worksheet ss:Name="Sheet1">
    <Table>
      <Row>
        <% if params[:is_individual] == "false" %>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Company</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Adress</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Email</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Phone</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Mobile</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Remark to admin</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">EC</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Total.Contacts</Data></Cell>
          <% CourseType.active_course_types.each do |ct| %>
             <Cell ss:StyleID="s63"><Data ss:Type="String"><%= ct.short_name %></Data></Cell>
          <% end %>
        <% else %>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Gender</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Full Name</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Company</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Payment Type</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">DOB</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Adress</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Preferred mailing</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Email</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Phone</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Mobile</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Remark to admin</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">ACCA Reg No</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">Courses</Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String">EC</Data></Cell>
        <% end %>
      </Row>
    <% @contacts.each_with_index do |contact,index| %>
<% logger.info index %>
      <Row>
        <% if params[:is_individual] == "false" %>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.name.titleize %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.address %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.email %><%= (";"+contact.email_2s.join(";")) if !contact.email_2s.empty? %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.phone %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.mobile %><%= (";"+contact.mobile_2s.join(";")) if !contact.mobile_2s.empty? %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.remark_to_admin %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.account_manager_list %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.company_contacts.count.to_s %></Data></Cell>
          # <% [].each do |ct| %>
          #   <% groups = contact.students_by_course_type(ct.id).group(:account_manager_id).select("account_manager_id, COUNT(*) as count").map {|c| [c.account_manager.name, c["count"]]} %>
          #    <Cell ss:StyleID="s63"><Data ss:Type="String"><% if groups.each_with_index do |g,ii| %><%=raw "&#10;" if ii != 0 %><%= "(#{g[1]}) #{g[0]}" %><% end.empty? %>0<% end %></Data></Cell>
          # <% end %>
          <% ctcs = contact.get_data["c.cache_course_types_count"] %>
          <% CourseType.active_course_types.each do |ct| %>
             <Cell ss:StyleID="s63"><Data ss:Type="String"><%=raw ctcs[ct.id.to_s] if !ctcs.nil? and !ctcs[ct.id.to_s].nil? %></Data></Cell>
          <% end %>
        <% else %>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.sex == "female" ? "[Ms]" : "[Mr]" %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.name.titleize %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.referrer.name if !contact.referrer.nil? %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.payment_type %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.birthday.strftime("%d-%b-%Y") if !contact.birthday.nil? %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.address %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.default_mailing_address %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.email %><%= (";"+contact.email_2s.join(";")) if !contact.email_2s.empty? %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.phone %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.mobile %><%= (";"+contact.mobile_2s.join(";")) if !contact.mobile_2s.empty? %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= contact.remark_to_admin %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><% if !contact.base_items.empty? %><% contact.base_items.each do |item| %><% if item["course_type"].present? and item["course_type"].short_name == 'ACCA' %><%= item["name"] %><% end %><% end %><% end %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= (contact.active_courses_with_phrases.map {|c| c[:course].name }).join('; ') %></Data></Cell>
           <Cell ss:StyleID="s63"><Data ss:Type="String"><%= !contact.account_manager.nil? ? contact.account_manager.name : "" %></Data></Cell>
        <% end %>
      </Row>
    <% end %>
    </Table>
  </Worksheet>
</Workbook>
